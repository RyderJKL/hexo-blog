---
title: 渐进式图片加载
date: 2017-04-25
tags: ['JavaScript','前端作品集']
toc: true
categories: technology

---
所谓渐进式图片加载，就是使用低分辨率图片来做预览图，代替以前懒加载图片时使用的 logo 占位图。预览图大小在 2kb～3kb之间。

其本的 HTML 结构如下：

```
<div class="progressive">
  <img class="preview lazy" data-src="origin.src" src="preview.jpg">
</div>
```

`origin.jpg` 就是原图，`preivew.jpg` 就是等比例压缩后的预览图。

容器基本样式:

```
.progressive {
  position: relative;
  display: block;
  overflow: hidden;
}
```

为了防止保证预览图被裁减后和原图尺寸不一致而导致容器尺寸在原图加载之后出现抖动的问题，最好的办法就是提前知道原图的尺寸，并让容器的尺寸等于原图的尺寸，这样就不会出现容器抖动的bug。

我们采用更简单的方法：

1. 预览图与原图尽量保持相同的宽高比例
2. 原图加载完成以后，不删除预览图，而是设置 opacity:0;


#### CSS 样式

```
.progressive {
  position: relative;
  display: block;
  overflow: hidden;
  img {
    display: block;
    width: 100%;
    max-width: 100%;
    // 让预览图和原图都充满容器
    height: auto;
    // 设置 height:atuo，使其保持原始比例
    border: 0 none;

    &.preview {
      filter: blur(2vw);
      // 让预览图具有相同的模糊度
      transform: scale(1.05);
      // 图片过度动画
    }

    &.hide{
      // 在原图加载完成以后隐藏预览图
      opacity: 0;
    }

    &.origin {
      // 让原图充满容器
      position: absolute;
      left:0;
      top:0;
      animation: origin 0.5s  ease-out;
      // 添加过渡动画
    }

    @keyframes origin {
      0% {
        transform: scale(1.1);
        opacity: 0;
      }

      100% {
        transform: scale(1.0);
        opacity: 1;
      }
    }
  }
}
```

#### JavaScript 代码

js 的处理逻辑主要还是懒加载的思想。主要使用 `checkImage` 函数在 DOMReady 和 scroll 时检查可视区域内是否有图片需要懒加载，然后是使用 `loadImage` 函数来替换预览图,并在图片加载的过程中触发过渡动画。

[原始js代码]()

[使用class封装后的]()

#### 图片裁切
多数 cdn 都会i提供图片上传后裁剪的功能。而对于 node.js 可以使用图片裁剪模块 `gm`。

对于简单裁剪 php 可以使用 gd 库，而 python 可以使用 pillow 库解决。

