---
title: SQL存储过程
date: 2016-07-05 09:26
tags: ['SQL查询的艺术','存储过程与函数']
toc: true
categories: technology

---
### 0x00
SQL调用例程是一个能被SQL调用的过程和函数。函数和过程都是预先定义的SQL语句，能够执行一定的操作。函数和过程本质上并没有太大的区别。

下面主要以SQL Server中存储过程为例，对于Oracle数据库只做简单介绍。

---
### 0x01 SQL Server中的控制流语句

---
#### begin---end 语句
定义一串由顺序执行的SQL语句构成的块。

---
#### IF---ELSE 语句
有条件的执行某些语句。

##### 例如在student表中查询学号110学生的成绩状况。

```
if (select min(mark) from student where sno='110') > 90
    pjrint '该生成绩全部优秀'
else
if (select min(mark) from student where sno='110') > 60
    print '该生成绩全部合格'
```

---
#### while，break和continue 语句

在student表中，如果110学生的平均成绩小于75，则将该生的每门成绩以5%的比例提高，当平均成绩都大于60时，终止操作。

```
while (select avg (mark) from student where sno='110') < 75
    begin 
        update student
        set mark = mark*1.05
        if (select min (mark) from student where sno='110' ) >=60
            break
    end
```

---
#### declare 语句
declare用来定义一个局部变量，可用select语句为该变量赋值，这个变量必须用@开头跟着一个标识符。

##### 在student表中查询学号110学生的成绩状况

```
declare @verygood int
    select @verygood = min(mark)
    from student
    where sno='110'
    if @verygood > 60
    print '成绩合格'
```

全局变量在形式上与局部变量不同，它们冠以两个@符号，如@@error。
  
局部变量的定义和使用必须在同一个存储过程中。

---
#### goto label 语句
goto label语句用来无条件将语句的执行顺序转到用户定义的标号(label)处，语法如下:

```
label1:
goto label
```

##### goto输出四个'hello'

```
declare @count_int int
select @count_int =1
restart:
print 'hello'
select @count_int=@count_int+1
while @count_int<=4
goto restart
```

---
#### waitfor
用来定义某天中的一个时刻，执行一个语句块。

语法:

```
waitfor { delay 'time' | time 'time' }
```

delay说明了SQL server 执行语句要等待时间。
time说明了要等到哪个时刻。

##### 在晚上22:20点执行存储过程uodate_all_stats

```
begin
	waitfor time '22:20'
	execute updata_all_stats
end
```

---
### 0x02 SQL Server中的存储过程和函数
在SQL Server中，存储过程分为两类:系统提供的存储过程和用户自定义的存储过程。系统存储过程主要存储在master数据库中，以sp_为前缀，主要是从系统表中获得信息。

主要有:
* __目录存储过程__
* __复制类存储过程__
* __安全管理类存储过程__
* __分布查询存储过程__

---
#### 创建存储过程

##### Create procedure
在SQL Server中我们可以使用Create Procedure创建，编译存储过程。

创建存储过程usp_show_teacher，用于查询所有教师信息

```
create procedure usp_show_teacher
as
select * from teacher
```

创建存储过程，usp_select_teacher，查询特定系教师的信息，判断教师的年龄结构并将该系教师的平均年龄和最大年龄传递给用户。

```
create procedure usp_select_teacher @depart char(10),@avg_age int OUTPUT,@max_avg int OUTPUT
as
select * from teacher
where dname=@depart
select @max_age=MAX(AGE)
from teacher
where dname=AVG(AGE)
from teacher
where dname=@dapart
if @avg_age<=30
select '年龄结构偏轻','平均年龄'=@avg_age
if @avg_age >30
select '年龄结构合理','平均年龄'=@avg_age
```

其中OUTPUT代表该参数是游标(cursor)数据类型，如果参数为游标类型，则该参数必须被指定为VARING和OUTPUT类型，OUTPUT表明该参数是一个返回参数，可以向调用者返回信息，但是TEXT类型的参数不能用作OUTPUT类型。

##### execute调用存储过程

 ```
declare @avgage int,@maxage int
execute usp_select_teacher '计算机',@avgage OUTPUT,@maxge OUTPUT
select @avgage,@maxage/*输出平均年龄与最大年龄*/
```

---
#### 创建函数
函数不能执行insert，update和delete操作。SQL Server中有三种类型的自定义函数:标量函数(Scalar Functions)，内联值型函数(Inline Table-valued Functions)，多声明表值型函数(Muti-statement Tabel-valued Functions)

---
#### 修改和删除存储过程

##### sp_helptext 查看存储过程源代码

```
sp_helptext sp_name
```

sp_name为存储过程的名称。

##### sp_rename重命名存储过程

```
sp_rename old_name,new_name
```

###### drop删除存储过程

```
drop sp_name
```



